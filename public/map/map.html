<html>

<head>
    <title>Map</title>
    <script src="https://unpkg.com/leaflet@1.5.0/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.0/dist/leaflet.css" />

    <script src="https://unpkg.com/leaflet-responsive-popup@0.6.4/leaflet.responsive.popup.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-responsive-popup@0.6.4/leaflet.responsive.popup.css" />

    <style>
        body {
            margin: 0;
        }

        #map {
            width: 100vw;
            height: 100vh
        }

        .mark {
            display: block;
            max-width: 200px;
            max-height: 200px;
            width: auto;
            height: auto;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        var map;
        var ajaxRequest;
        var plotlist;
        var dumpdata;
        var plotlayers = [];
        var markers = [];
        var latlon = []
        var remove = []


        async function getdata() {
            var e = await fetch('/api')
            var data = await e.json()
            return data;
        }

        function addmarkernocom(lat, lon, url) {
            var marker = L.marker([lat, lon]).addTo(map);
            var popup = L.popup()
                .setContent(`<img src=${url} class="mark">`);
            marker.bindPopup(popup)
            markers.push(marker);
        }

        function addmarker(lat, lon, url, comment) {
            var marker = L.marker([lat, lon]).addTo(map);
            var popup = L.popup()
                .setContent(`<img src=${url} class="mark"><p>Comment => ${comment} (only for vip users)`);
            marker.bindPopup(popup)
            markers.push(marker);
        }

        function addpolygon() {
            var polygon = L.polyline(latlon, {
                color: "blue",
smoothFactor: 0.5
            }).addTo(map);
        }


        function maxmin() {
            var myBounds = new L.LatLngBounds(latlon);
            map.fitBounds(myBounds);
        }

        function closephaze() {
            dumpdata.forEach(e => {
                if (e.location.lat == 0 && e.location.lon == 0) return;
                if (e.comment) {
                    addmarker(lat, lon, e.image, e.comment)
                } else {
                    addmarkernocom(e.location.lat, e.location.lon, e.image)
                }
            })
            maxmin()
            addpolygon();
        }

        function datamanager() {
            getdata().then(data => {
                data.forEach(e => {
                    var {
                        lat,
                        lon
                    } = e.location;
                    if (lat == 0 && lon == 0) return;
                    latlon.push([lat, lon])
                })
                dumpdata = data;
                document.onclick = () => {
                    for (var i = 0; i > markers.length; i++) {
                        var marker = markers[i]
                        marker.openPopup();
                    }
                }
                closephaze();
            })
        }

        // Init Open Street Maps
        function initmap() {
            // set up the map
            map = new L.Map('map');
            var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            var osmAttrib = 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
            var osm = new L.TileLayer(osmUrl, {
                minZoom: 2,
                maxZoom: 19,
                attribution: osmAttrib
            });
            map.addLayer(osm);

            datamanager();
        }

        initmap();
    </script>
</body>

</html>